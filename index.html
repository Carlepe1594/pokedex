<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pok√©dex Visual ‚Äî Equipo (A√±il 4.0) v4.4</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --card:#0f1730; --muted:#a9b3d1; --text:#eef2ff;
      --accent:#7c5cff; --accent2:#2dd4bf; --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
                  radial-gradient(900px 700px at 80% 30%, rgba(45,212,191,.18), transparent 55%),
                  linear-gradient(180deg, #070a14, var(--bg));
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,16,32,.78);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px;}
    .topbar{display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.8));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:800;
    }
    .title h1{margin:0; font-size:18px; letter-spacing:.2px}
    .title p{margin:2px 0 0; color:var(--muted); font-size:12px}

    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input, select, button{
      font-family:inherit;
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      outline:none;
    }
    input{min-width:260px}
    select{min-width:190px}
    button{cursor:pointer; transition:.15s transform, .15s opacity;}
    button:hover{transform: translateY(-1px)}
    button.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(124,92,255,.55));
      border-color: rgba(124,92,255,.35);
    }
    button.ghost{background: transparent;}

    main .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      padding:16px;
      max-width:1180px;
      margin:0 auto;
    }
    @media (max-width: 980px){
      main .grid{grid-template-columns:1fr}
    }

    .panel{
      background: rgba(18,26,51,.72);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
    }
    .panel-head h2{margin:0; font-size:14px; letter-spacing:.3px; color:rgba(255,255,255,.92)}
    .panel-head small{color:var(--muted)}

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      padding:14px;
    }
    @media (max-width: 560px){
      .cards{grid-template-columns:1fr}
      input{min-width:100%}
      select{min-width:100%}
    }

    .card{
      background: linear-gradient(180deg, rgba(15,23,48,.92), rgba(15,23,48,.72));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      display:grid;
      grid-template-columns: 76px 1fr;
      gap:12px;
      cursor:pointer;
      transition: .16s transform, .16s border-color, .16s background;
      min-width:0;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(124,92,255,.35);
      background: linear-gradient(180deg, rgba(15,23,48,.98), rgba(15,23,48,.75));
    }
    .sprite{
      width:76px; height:76px;
      border-radius: 18px;
      background: rgba(255,255,255,.06);
      border:1px dashed rgba(255,255,255,.14);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .sprite img{width:76px; height:76px; image-rendering: pixelated;}
    .card h3{margin:0; font-size:14px}
    .meta{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}

    .chip{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      white-space: normal;
      overflow-wrap: anywhere;
      max-width: 100%;
    }
    .chip.dim{color: var(--muted)}
    .types{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}

    .type{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(124,92,255,.12);
      color: rgba(255,255,255,.92);
      display:inline-block;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* Paleta tipos */
    .type.type-grass   { background: rgba(34,197,94,.24);   border-color: rgba(34,197,94,.38); }
    .type.type-water   { background: rgba(56,189,248,.24);  border-color: rgba(56,189,248,.38); }
    .type.type-ghost   { background: rgba(168,85,247,.24);  border-color: rgba(168,85,247,.38); }
    .type.type-dragon  { background: rgba(30,64,175,.26);   border-color: rgba(30,64,175,.40); }
    .type.type-ground  { background: rgba(216,145,56,.24);  border-color: rgba(216,145,56,.38); }
    .type.type-rock    { background: rgba(140,86,33,.26);   border-color: rgba(140,86,33,.42); }
    .type.type-dark    { background: rgba(15,23,42,.42);    border-color: rgba(148,163,184,.18); }
    .type.type-steel   { background: rgba(100,116,139,.30); border-color: rgba(148,163,184,.40); }
    .type.type-flying  { background: rgba(241,245,249,.22); border-color: rgba(241,245,249,.35); }
    .type.type-fairy   { background: rgba(251,207,232,.20); border-color: rgba(251,207,232,.34); }
    .type.type-fire    { background: rgba(244,63,94,.24);   border-color: rgba(244,63,94,.38); }
    .type.type-poison  { background: rgba(147,51,234,.22);  border-color: rgba(147,51,234,.34); }
    .type.type-ice     { background: rgba(45,212,191,.20);  border-color: rgba(45,212,191,.34); }
    .type.type-electric{ background: rgba(250,204,21,.20);  border-color: rgba(250,204,21,.34); }
    .type.type-psychic { background: rgba(236,72,153,.20);  border-color: rgba(236,72,153,.34); }
    .type.type-bug     { background: rgba(163,230,53,.18);  border-color: rgba(163,230,53,.30); }
    .type.type-normal  { background: rgba(203,213,225,.16); border-color: rgba(203,213,225,.28); }
    .type.type-fighting{ background: rgba(234,88,12,.18);   border-color: rgba(234,88,12,.30); }

    .detail{padding:14px; display:grid; gap:12px;}
    .hero{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      padding:12px; border:1px solid var(--line); border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      min-width:0;
    }
    .hero-left{display:flex; gap:12px; align-items:center; min-width:0}
    .hero .big{
      width:92px; height:92px; border-radius: 22px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center; overflow:hidden;
      flex: 0 0 auto;
    }
    .hero .big img{width:92px; height:92px; image-rendering: pixelated;}

    .kv{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .box{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.04);
      padding:12px;
      min-width:0;
    }
    .box h4{margin:0 0 10px; font-size:12px; color: rgba(255,255,255,.86); letter-spacing:.2px}
    .hint{color: var(--muted); font-size: 12px; line-height: 1.4;}

    .moves{display:flex; flex-wrap:wrap; gap:8px;}
    .move{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      padding:6px 10px;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
    }
    .move .tag{font-size:11px; padding:3px 8px; border-radius:999px;}
    .move .tag.type{padding:3px 8px; font-size:11px}

    .file{display:none;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: rgba(255,255,255,.92);
      font-size: 12px;
      max-width:100%;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    /* Tabs */
    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tabBtn{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      cursor:pointer;
    }
    .tabBtn.active{
      border-color: rgba(124,92,255,.55);
      background: rgba(124,92,255,.18);
    }

    /* Pok√©dex click picker */
    .typePickWrap{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      user-select:none;
    }
    .typePick{
      border:none;
      padding:0;
      background:none;
      cursor:pointer;
      border-radius:999px;
      outline:none;
    }
    .typePick .type{
      transition: .12s transform, .12s box-shadow, .12s opacity;
    }
    .typePick:hover .type{ transform: translateY(-1px); }

    .typePick.selected1 .type{
      box-shadow: inset 0 0 0 2px rgba(124,92,255,.70), 0 0 0 3px rgba(124,92,255,.12);
    }
    .typePick.selected2 .type{
      box-shadow: inset 0 0 0 2px rgba(45,212,191,.65), 0 0 0 3px rgba(45,212,191,.10);
    }

    .pickedLine{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      margin-top:10px;
    }
    .pill2{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px;
    }

    .pokedexGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width: 560px){ .pokedexGrid{grid-template-columns:1fr} }
    .bucketTitle{margin:0 0 8px; font-size:12px; color: rgba(255,255,255,.86)}
    .bucket{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      padding:12px;
      min-width:0;
    }
    .bucket .list{display:flex; flex-wrap:wrap; gap:8px;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">‚ö°</div>
        <div class="title">
          <h1>Pok√©dex Visual ‚Äî Equipo (A√±il 4.0) v4.4</h1>
          <p>Pok√©dex por tipos: ahora funciona en ‚Äúcadena‚Äù y Limpiar deja ambos vac√≠os.</p>
        </div>
      </div>

      <div class="controls">
        <input id="q" type="search" placeholder="Buscar (ej: Charizard, naturaleza, habilidad‚Ä¶)" />
        <select id="fNature"><option value="">Naturaleza: todas</option></select>
        <select id="fAbility"><option value="">Habilidad: todas</option></select>
        <button class="primary" id="exportBtn">Exportar JSON</button>
        <button class="ghost" id="importBtn">Importar JSON</button>
        <input class="file" id="file" type="file" accept="application/json" />
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="panel">
      <div class="panel-head">
        <div>
          <h2>Equipo (12)</h2>
          <small id="countLabel">Mostrando 12</small>
        </div>
        <div class="pill">üß† <span>Click en una tarjeta para ver todo.</span></div>
      </div>
      <div class="cards" id="cards"></div>
    </section>

    <aside class="panel">
      <div class="panel-head">
        <div>
          <h2>Panel</h2>
          <small id="subTitle">Detalle del Pok√©mon seleccionado</small>
        </div>
        <div class="tabs">
          <button class="tabBtn active" id="tabDetail">Detalle</button>
          <button class="tabBtn" id="tabPokedex">Pok√©dex</button>
        </div>
      </div>

      <div class="detail" id="rightPane"></div>
    </aside>
  </div>
</main>

<script>
  // ====== DATOS ======
  const DATA = [
    { name:"Rillaboom", apiId:"rillaboom", how:"Intercambio por Victreebel (Fluxus)", nature:"Firme", ability:"Herbog√©nesis", item:"Semilla Milagro",
      moves:["Deslizador Grama","Mazazo","Desarme","Ida y Vuelta"] },
    { name:"Dragapult", apiId:"dragapult", how:"Dreepy Ruta 22", nature:"Alegre", ability:"Allanamiento", item:"Garra Drag√≥n (objeto)",
      moves:["Dardos Drag√≥n","Sombra Vil","Ida y Vuelta","Lanzallamas"] },
    { name:"Garchomp", apiId:"garchomp", how:"Gabite Exp. Luminalia Sur", nature:"Alegre", ability:"Piel Tosca", item:"Casco Dentado",
      moves:["Terremoto","Garra Drag√≥n","Avalancha","Danza Espada"] },
    { name:"Corviknight", apiId:"corviknight", how:"Corvisquire Ruta 12", nature:"Agitada", ability:"Reflejo Espejo", item:"Restos",
      moves:["P√°jaro Osado","Respiro","Cabeza de Hierro","Despejar"] },
    { name:"Toxapex", apiId:"toxapex", how:"Isla Montesanto", nature:"Serena", ability:"Regeneraci√≥n", item:"Lodo Negro",
      moves:["Escaldar","T√≥xico","Recuperaci√≥n","Niebla"] },
    { name:"Charizard (Mega X)", apiId:"charizard-mega-x", how:"Intercambio Rapidash Caf√© Bohemie", nature:"Alegre", ability:"Mar Llamas ‚Üí Garra Dura", item:"Charizardita X",
      moves:["Danza Drag√≥n","Envite √çgneo","Garra Drag√≥n","Terremoto"] },
    { name:"Volcarona", apiId:"volcarona", how:"Larvesta Ruta 21", nature:"Miedosa", ability:"Cuerpo Llama", item:"Carb√≥n",
      moves:["Danza Aleteo","Danza Llama","Zumbido","Gigadrenado"] },
    { name:"Tyranitar", apiId:"tyranitar", how:"Larvitar Pirineos de Kalos", nature:"Firme", ability:"Chorro Arena", item:"Roca Suave",
      moves:["Roca Afilada","Triturar","Terremoto","Danza Drag√≥n"] },
    { name:"Excadrill", apiId:"excadrill", how:"Drilbur Cueva Grisalla", nature:"Alegre", ability:"√çmpetu Arena", item:"Cinta Fuerte",
      moves:["Terremoto","Cabeza de Hierro","Avalancha","Danza Espada"] },
    { name:"Kingambit", apiId:"kingambit", how:"Pawniard Ruta 18", nature:"Firme", ability:"General Supremo", item:"Gafas Negras",
      moves:["Tajo Sombr√≠o","Cabeza de Hierro","Golpe Bajo","Danza Espada"] },
    { name:"Greninja", apiId:"greninja", how:"Inicial Kalos", nature:"Miedosa", ability:"Mutatipo", item:"Agua M√≠stica",
      moves:["Hidrobomba","Rayo Hielo","Pulso Umbr√≠o","Ida y Vuelta"] },
    { name:"Primarina", apiId:"primarina", how:"Intercambio Sharpedo Luminalia Oeste", nature:"Modesta", ability:"Torrente", item:"Perla Grande",
      moves:["Fuerza Lunar","Surf","Rayo Hielo","Paz Mental"] },
  ];

  const MOVE_TYPE = {
    "Deslizador Grama":"grass","Mazazo":"grass","Desarme":"dark","Ida y Vuelta":"bug",
    "Dardos Drag√≥n":"dragon","Sombra Vil":"ghost","Lanzallamas":"fire",
    "Terremoto":"ground","Garra Drag√≥n":"dragon","Avalancha":"rock","Danza Espada":"normal",
    "P√°jaro Osado":"flying","Respiro":"flying","Cabeza de Hierro":"steel","Despejar":"flying",
    "Escaldar":"water","T√≥xico":"poison","Recuperaci√≥n":"normal","Niebla":"ice",
    "Danza Drag√≥n":"dragon","Envite √çgneo":"fire",
    "Danza Aleteo":"bug","Danza Llama":"fire","Zumbido":"bug","Gigadrenado":"grass",
    "Roca Afilada":"rock","Triturar":"dark",
    "Tajo Sombr√≠o":"dark","Golpe Bajo":"dark",
    "Hidrobomba":"water","Rayo Hielo":"ice","Pulso Umbr√≠o":"dark",
    "Fuerza Lunar":"fairy","Surf":"water","Paz Mental":"psychic"
  };

  const TYPES = ["normal","fire","water","electric","grass","ice","fighting","poison","ground","flying","psychic","bug","rock","ghost","dragon","dark","steel","fairy"];
  const TYPE_LABEL = {
    normal:"Normal", fire:"Fuego", water:"Agua", electric:"El√©ctrico", grass:"Planta", ice:"Hielo",
    fighting:"Lucha", poison:"Veneno", ground:"Tierra", flying:"Volador", psychic:"Ps√≠quico", bug:"Bicho",
    rock:"Roca", ghost:"Fantasma", dragon:"Drag√≥n", dark:"Siniestro", steel:"Acero", fairy:"Hada"
  };

  const CHART = {
    normal:{super:[],half:["rock","steel"],zero:["ghost"]},
    fire:{super:["grass","ice","bug","steel"],half:["fire","water","rock","dragon"],zero:[]},
    water:{super:["fire","ground","rock"],half:["water","grass","dragon"],zero:[]},
    electric:{super:["water","flying"],half:["electric","grass","dragon"],zero:["ground"]},
    grass:{super:["water","ground","rock"],half:["fire","grass","poison","flying","bug","dragon","steel"],zero:[]},
    ice:{super:["grass","ground","flying","dragon"],half:["fire","water","ice","steel"],zero:[]},
    fighting:{super:["normal","ice","rock","dark","steel"],half:["poison","flying","psychic","bug","fairy"],zero:["ghost"]},
    poison:{super:["grass","fairy"],half:["poison","ground","rock","ghost"],zero:["steel"]},
    ground:{super:["fire","electric","poison","rock","steel"],half:["grass","bug"],zero:["flying"]},
    flying:{super:["grass","fighting","bug"],half:["electric","rock","steel"],zero:[]},
    psychic:{super:["fighting","poison"],half:["psychic","steel"],zero:["dark"]},
    bug:{super:["grass","psychic","dark"],half:["fire","fighting","poison","flying","ghost","steel","fairy"],zero:[]},
    rock:{super:["fire","ice","flying","bug"],half:["fighting","ground","steel"],zero:[]},
    ghost:{super:["psychic","ghost"],half:["dark"],zero:["normal"]},
    dragon:{super:["dragon"],half:["steel"],zero:["fairy"]},
    dark:{super:["psychic","ghost"],half:["fighting","dark","fairy"],zero:[]},
    steel:{super:["ice","rock","fairy"],half:["fire","water","electric","steel"],zero:[]},
    fairy:{super:["fighting","dragon","dark"],half:["fire","poison","steel"],zero:[]}
  };

  function mult(atk, def){
    const r = CHART[atk];
    if(r.zero.includes(def)) return 0;
    if(r.super.includes(def)) return 2;
    if(r.half.includes(def)) return 0.5;
    return 1;
  }

  function multDefAgainst(def1, def2, atk){
    const m1 = def1 ? mult(atk, def1) : 1;
    const m2 = def2 ? mult(atk, def2) : 1;
    return m1 * m2;
  }

  const pokeCache = new Map();
  const evoCache = new Map();

  const elCards = document.getElementById("cards");
  const rightPane = document.getElementById("rightPane");
  const elCount = document.getElementById("countLabel");
  const elQ = document.getElementById("q");
  const elNature = document.getElementById("fNature");
  const elAbility = document.getElementById("fAbility");
  const elExport = document.getElementById("exportBtn");
  const elImport = document.getElementById("importBtn");
  const elFile = document.getElementById("file");
  const tabDetail = document.getElementById("tabDetail");
  const tabPokedex = document.getElementById("tabPokedex");
  const subTitle = document.getElementById("subTitle");

  let state = { list: structuredClone(DATA), filtered: structuredClone(DATA), selected: DATA[0] };
  let activeTab = "detail";

  // ‚úÖ Ahora s√≠: limpiar deja ambos vac√≠os
  let pdType1 = "";
  let pdType2 = "";

  const norm = (s) => (s ?? "").toString().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu, "");
  const uniq = (arr) => Array.from(new Set(arr)).filter(Boolean).sort((a,b)=>a.localeCompare(b,"es"));
  const cap = (s)=> s ? s.charAt(0).toUpperCase()+s.slice(1) : s;

  function typeBadge(t){ return `<span class="type type-${t}">${TYPE_LABEL[t] || t}</span>`; }

  async function fetchPokemon(apiId){
    if(!apiId) return null;
    if(pokeCache.has(apiId)) return pokeCache.get(apiId);
    try{
      const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${encodeURIComponent(apiId)}`);
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      const sprite = data?.sprites?.other?.["official-artwork"]?.front_default || data?.sprites?.front_default || null;
      const types = (data?.types ?? []).map(t => t?.type?.name).filter(Boolean);
      const cry = data?.cries?.latest || data?.cries?.legacy || null;
      const pack = { sprite, types, cry };
      pokeCache.set(apiId, pack);
      return pack;
    } catch {
      const pack = { sprite:null, types:[], cry:null, error:true };
      pokeCache.set(apiId, pack);
      return pack;
    }
  }

  async function fetchEvolutionLine(apiId){
    if(!apiId) return [];
    if(evoCache.has(apiId)) return evoCache.get(apiId);
    try{
      const pRes = await fetch(`https://pokeapi.co/api/v2/pokemon/${encodeURIComponent(apiId)}`);
      if(!pRes.ok) throw new Error("pokemon failed");
      const pData = await pRes.json();
      const speciesUrl = pData?.species?.url;
      if(!speciesUrl) return [];
      const sRes = await fetch(speciesUrl);
      if(!sRes.ok) throw new Error("species failed");
      const sData = await sRes.json();
      const evoUrl = sData?.evolution_chain?.url;
      if(!evoUrl) return [];
      const eRes = await fetch(evoUrl);
      if(!eRes.ok) throw new Error("evo failed");
      const eData = await eRes.json();
      const line = [];
      let node = eData?.chain;
      while(node && line.length < 3){
        const name = node?.species?.name;
        if(name) line.push(name);
        node = node?.evolves_to?.[0];
      }
      evoCache.set(apiId, line);
      return line;
    } catch {
      evoCache.set(apiId, []);
      return [];
    }
  }

  function buildFilters(){
    const natures = uniq(state.list.map(p=>p.nature));
    const abilities = uniq(state.list.map(p=>p.ability));
    elNature.innerHTML = `<option value="">Naturaleza: todas</option>` + natures.map(v=>`<option value="${v}">${v}</option>`).join("");
    elAbility.innerHTML = `<option value="">Habilidad: todas</option>` + abilities.map(v=>`<option value="${v}">${v}</option>`).join("");
  }

  function applyFilters(){
    const q = norm(elQ.value);
    const fN = elNature.value;
    const fA = elAbility.value;

    state.filtered = state.list.filter(p=>{
      if(fN && p.nature !== fN) return false;
      if(fA && p.ability !== fA) return false;
      if(!q) return true;
      const blob = norm([p.name, p.how, p.nature, p.ability, p.item, ...(p.moves||[])].join(" | "));
      return blob.includes(q);
    });

    elCount.textContent = `Mostrando ${state.filtered.length}`;
    renderCards();
    if(state.filtered.length){
      state.selected = state.filtered[0];
      if(activeTab === "detail") renderDetail(state.selected);
    }
  }

  function cardHTML(p){
    return `
      <div class="card" role="button" tabindex="0">
        <div class="sprite"><div style="font-size:24px; opacity:.8">üü£</div></div>
        <div style="min-width:0">
          <h3>${p.name}</h3>
          <div class="meta">
            <span class="chip">${p.nature}</span>
            <span class="chip dim">${p.ability}</span>
          </div>
          <div class="types"></div>
        </div>
      </div>
    `;
  }

  async function renderCards(){
    const list = state.filtered;
    elCards.innerHTML = list.map(cardHTML).join("");

    const nodes = Array.from(elCards.querySelectorAll(".card"));
    nodes.forEach((node, i)=>{
      const p = list[i];
      const go = ()=>{
        state.selected = p;
        if(activeTab === "detail") renderDetail(p);
      };
      node.addEventListener("click", go);
      node.addEventListener("keydown", (e)=>{ if(e.key === "Enter" || e.key === " "){ e.preventDefault(); go(); }});
    });

    await Promise.all(list.map(async (p, i)=>{
      const media = await fetchPokemon(p.apiId);
      const node = nodes[i];
      if(!node) return;

      const spriteBox = node.querySelector(".sprite");
      if(spriteBox && media?.sprite) spriteBox.innerHTML = `<img alt="${p.name}" src="${media.sprite}">`;

      const typesBox = node.querySelector(".types");
      if(typesBox) typesBox.innerHTML = (media?.types ?? []).slice(0,2).map(typeBadge).join("");
    }));
  }

  function moveChip(moveName){
    const t = MOVE_TYPE[moveName];
    const tag = t ? `<span class="tag type type-${t}">${TYPE_LABEL[t] || t}</span>` : `<span class="tag">?</span>`;
    return `<span class="move">${tag}<span>${moveName}</span></span>`;
  }

  async function renderDetail(p){
    subTitle.textContent = "Detalle del Pok√©mon seleccionado";
    const media = await fetchPokemon(p.apiId);
    const sprite = media?.sprite;
    const types = media?.types ?? [];
    const cry = media?.cry;

    const evo = await fetchEvolutionLine(p.apiId);
    const evoHTML = evo.length
      ? `<div class="moves" style="overflow-x:auto;-webkit-overflow-scrolling:touch">${evo.map(n=>`<span class="move">${cap(n)}</span>`).join("")}</div>`
      : `<div class="hint">No disponible (sin internet).</div>`;

    const movesHTML = (p.moves||[]).map(moveChip).join("");

    rightPane.innerHTML = `
      <div class="hero">
        <div class="hero-left">
          <div class="big">${sprite ? `<img alt="${p.name}" src="${sprite}">` : `<div style="font-size:30px; opacity:.85">üü£</div>`}</div>
          <div style="min-width:0">
            <h2 style="margin:0">${p.name}</h2>
            <div style="margin-top:8px; overflow-x:auto; -webkit-overflow-scrolling:touch">
              ${types.length ? types.map(typeBadge).join(" ") : `<span class="hint">Tipos: (no disponibles)</span>`}
            </div>
            <div class="meta" style="margin-top:10px">
              <span class="chip">${p.nature}</span>
              <span class="chip dim">${p.ability}</span>
              <span class="chip dim">${p.item}</span>
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          ${cry ? `<audio controls src="${cry}" title="Cry"></audio>` : ``}
        </div>
      </div>

      <div class="kv">
        <div class="box">
          <h4>C√≥mo obtenerlo</h4>
          <div class="hint">${p.how}</div>
        </div>

        <div class="box">
          <h4>Evoluci√≥n (l√≠nea principal)</h4>
          ${evoHTML}
          <div class="hint" style="margin-top:8px">Si hay ramificaciones, se muestra la primera.</div>
        </div>

        <div class="box" style="grid-column:1 / -1">
          <h4>Movimientos (coloreados por tipo)</h4>
          <div class="moves">${movesHTML}</div>
        </div>
      </div>
    `;
  }

  function classifyDefense(def1, def2){
    const buckets = { "4":[], "2":[], "1":[], "0.5":[], "0.25":[], "0":[] };
    for(const atk of TYPES){
      const m = multDefAgainst(def1, def2, atk);
      if(m === 4) buckets["4"].push(atk);
      else if(m === 2) buckets["2"].push(atk);
      else if(m === 1) buckets["1"].push(atk);
      else if(m === 0.5) buckets["0.5"].push(atk);
      else if(m === 0.25) buckets["0.25"].push(atk);
      else if(m === 0) buckets["0"].push(atk);
    }
    return buckets;
  }

  function offensiveStrong(atk1, atk2){
    const strong = [];
    if(!atk1 && !atk2) return strong;
    for(const def of TYPES){
      const m1 = atk1 ? mult(atk1, def) : 0;
      const m2 = atk2 ? mult(atk2, def) : 0;
      const best = Math.max(m1, m2);
      if(best === 2) strong.push(def);
    }
    return strong;
  }

  function renderPokedex(){
    subTitle.textContent = "Pok√©dex de tipos (cadena lineal)";

    rightPane.innerHTML = `
      <div class="box">
        <h4>Pok√©dex ‚Äî Debilidades / resistencias / inmunidades</h4>
        <div class="hint">
          <b>Cadena:</b> cuando ya hay 2 tipos, cada clic hace: <b>Tipo2 = Tipo1</b> y <b>Tipo1 = nuevo</b>.
          <br>Bot√≥n <b>Limpiar</b> deja ambos vac√≠os.
        </div>

        <div class="pickedLine">
          <div class="pill2"><b>Tipo 1:</b> <span id="showT1"></span></div>
          <div class="pill2"><b>Tipo 2:</b> <span id="showT2"></span></div>
          <button class="ghost" id="clearTypes">Limpiar</button>
        </div>

        <div class="typePickWrap" id="typePickWrap">
          ${TYPES.map(t=>`
            <button class="typePick" data-t="${t}" aria-label="${TYPE_LABEL[t]}">
              ${typeBadge(t)}
            </button>
          `).join("")}
        </div>

        <div id="pokedexOut" style="margin-top:12px"></div>
      </div>
    `;

    const wrap = document.getElementById("typePickWrap");
    const showT1 = document.getElementById("showT1");
    const showT2 = document.getElementById("showT2");
    const clearBtn = document.getElementById("clearTypes");

    function refreshPickStyles(){
      wrap.querySelectorAll(".typePick").forEach(btn=>{
        const t = btn.dataset.t;
        btn.classList.toggle("selected1", t === pdType1);
        btn.classList.toggle("selected2", t === pdType2);
      });
      showT1.innerHTML = pdType1 ? typeBadge(pdType1) : `<span class="hint">‚Äî</span>`;
      showT2.innerHTML = pdType2 ? typeBadge(pdType2) : `<span class="hint">‚Äî</span>`;
    }

    function draw(){
      const hasAny = !!pdType1 || !!pdType2;

      if(!hasAny){
        document.getElementById("pokedexOut").innerHTML = `
          <div class="bucket">
            <p class="bucketTitle">Resultado</p>
            <div class="hint">Elige al menos un tipo para calcular.</div>
          </div>
        `;
        return;
      }

      const buckets = classifyDefense(pdType1, pdType2);
      const mk = (title, multKey, subtitle) => `
        <div class="bucket">
          <p class="bucketTitle">${title} <span class="hint">${subtitle||""}</span></p>
          <div class="list">${(buckets[multKey]||[]).map(typeBadge).join("") || `<span class="hint">‚Äî</span>`}</div>
        </div>
      `;
      const strong = offensiveStrong(pdType1, pdType2);

      document.getElementById("pokedexOut").innerHTML = `
        <div class="pokedexGrid">
          ${mk("Debilidades", "4", "4x")}
          ${mk("Debilidades", "2", "2x")}
          ${mk("Resistencias", "0.5", "¬Ωx")}
          ${mk("Resistencias", "0.25", "¬ºx")}
          ${mk("Inmunidades", "0", "0x")}
          <div class="bucket">
            <p class="bucketTitle">Ofensiva fuerte <span class="hint">(2x vs defensas mono-tipo)</span></p>
            <div class="list">${strong.map(typeBadge).join("") || `<span class="hint">‚Äî</span>`}</div>
          </div>
        </div>
      `;
    }

    function pickType(t){
      // si no hay Tipo 1 a√∫n
      if(!pdType1){
        pdType1 = t;
        refreshPickStyles(); draw();
        return;
      }

      // si hay Tipo 1 pero no Tipo 2
      if(pdType1 && !pdType2){
        if(t === pdType1) return; // evitar duplicado
        pdType2 = t;
        refreshPickStyles(); draw();
        return;
      }

      // ya hay ambos: CADENA
      if(pdType1 && pdType2){
        if(t === pdType1) return; // opcional: ignorar click repetido
        pdType2 = pdType1;
        pdType1 = t;

        // seguridad: no iguales
        if(pdType1 === pdType2){
          // no deber√≠a pasar por el return, pero por si acaso
          pdType2 = "";
        }

        refreshPickStyles();
        draw();
      }
    }

    wrap.addEventListener("click", (e)=>{
      const btn = e.target.closest(".typePick");
      if(!btn) return;
      pickType(btn.dataset.t);
    });

    clearBtn.addEventListener("click", ()=>{
      pdType1 = "";
      pdType2 = "";
      refreshPickStyles();
      draw();
    });

    refreshPickStyles();
    draw();
  }

  function setTab(tab){
    activeTab = tab;
    if(tab === "detail"){
      tabDetail.classList.add("active");
      tabPokedex.classList.remove("active");
      renderDetail(state.selected || state.filtered[0] || state.list[0]);
    } else {
      tabPokedex.classList.add("active");
      tabDetail.classList.remove("active");
      renderPokedex();
    }
  }

  elExport.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state.list, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "equipo_pokemon.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  elImport.addEventListener("click", ()=> elFile.click());
  elFile.addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      if(!Array.isArray(json)) throw new Error("El JSON debe ser un arreglo de Pok√©mon.");
      state.list = json;
      buildFilters();
      applyFilters();
    } catch(err){
      alert("No pude importar ese JSON.\n\n" + err.message);
    } finally {
      elFile.value = "";
    }
  });

  tabDetail.addEventListener("click", ()=> setTab("detail"));
  tabPokedex.addEventListener("click", ()=> setTab("pokedex"));

  function init(){
    buildFilters();
    elQ.addEventListener("input", applyFilters);
    elNature.addEventListener("change", applyFilters);
    elAbility.addEventListener("change", applyFilters);

    applyFilters();
    setTab("detail");
  }
  init();
</script>
</body>
</html>
